## userpass

文档地址：<https://developer.hashicorp.com/vault/docs/auth/userpass>

userpass 身份验证方法允许用户使用一组用户名密码登录 Vault

这组用户名密码直接通过 users/ 路径配置进该验证方法

```bash
# 启用
vault auth enable userpass

# 禁用
vault auth disable userpass
```

列出已启用的身份验证方法

```bash
vault auth list
# vault auth list -detailed
```

### 创建账号

创建一个账号，密码为 secret

```bash
vault write auth/userpass/users/user_using_pass password=secret
```

在创建账号的时候，也支持定义策略，例如这种写法：

```bash
vault write auth/userpass/users/user_using_pass password=secret policies=secert-readonly
# 请先确保 policy 已经创建
```

使用上面的账号和密码登录

```bash
vault login -method=userpass username=user_using_pass password=secret
```

### entity_id

登录时查看

```bash
vault login -method=userpass username=user_using_pass password='secret' -format=json | jq -r '.auth.entity_id'
```

### tune TLL

tune 命令， 调整指定路径上的身份验证方法的配置选项

```bash
vault read sys/auth/userpass/tune

# 调整下 TTL 时长
vault auth tune -default-lease-ttl=900h userpass
vault auth tune -max-lease-ttl=900h userpass
```

对于 token，也可以使用 tune 调整，操作方法如下：

```bash
vault read sys/auth/token/tune

# 调整 token 的 TTL 为 1200h
vault auth tune -max-lease-ttl=1200h -default-lease-ttl=1200h token

# tune 后，再创建一个 token
vault token create 

# 查看新的 token 的 ttl 时间，可以看到已经生效
# 需要注意的是之前创建的 token 的 ttl 的时间还是保持之前的 768h
vault token lookup hvs....
```

### 删除校验

delete 命令从 Vault 中删除指定路径上的机密和配置。删除操作的具体实现是委托给具体路径上挂载的后端实现的

```bash
vault write sys/auth/my-auth type=userpass
vault auth list
vault read sys/auth/my-auth
vault delete sys/auth/my-auth
```

## MFA

文档地址：<https://developer.hashicorp.com/vault/tutorials/auth-methods/active-directory-mfa-login-totp>

对指定对象启用 MFA

```bash
ENTITY_ID="176fe1ed-a464-9282-8367-2a405cc3ccb2"
vault write identity/mfa/method/totp \
    -format=json \
    generate=true \
    issuer=Vault \
    period=30 \
    key_size=30 \
    algorithm=SHA256 \
    digits=6 | jq -r '.data.method_id'
```

上述命令输出 `TOTP_METHOD_ID`

```bash
TOTP_METHOD_ID='c99214b8-fb2c-4965-b43f-9555337a81c3'
vault write -field=barcode \
    /identity/mfa/method/totp/admin-generate \
    method_id=$TOTP_METHOD_ID entity_id=$ENTITY_ID \
    | base64 -d > /tmp/qr-code.png
```

创建登录 MFA 强制执行

```bash
vault auth list -format=json --detailed | grep accessor
```

实施 MFA

```bash
ACCESSOR='auth_userpass_313fa6a8'
vault write /identity/mfa/login-enforcement/adtotp \
    mfa_method_ids="$TOTP_METHOD_ID" \
    auth_method_accessors=$ACCESSOR
```

设置完成后，从页面选择 userpass 登录会出现

## 对接 Authentik

创建 OIDC APP，并添加回调允许地址：

```plain
https://vault.company.com/ui/vault/auth/oidc/oidc/callback
https://vault.company.com/oidc/callback
http://localhost:8250/oidc/callback
```

Vault 侧配置：

```bash
vault auth enable oidc

vault write auth/oidc/config \
    oidc_discovery_url="https://authentik.company.com/application/o/<application_slug>/" \
    oidc_client_id="<idp_client_id>" \
    oidc_client_secret="<idp_secret>" \
    default_role="admin"
```

绑定策略

```bash
# 管理员策略 ：对所有路径的完全访问权限
vault policy write vault-admin - <<EOF
path "*" {
    capabilities = ["sudo","read","create","update","delete","list","patch"]
}
EOF

# 读取策略 ：可只读访问 kv/ 路径中的密钥值
vault policy write vault-kv-reader - <<EOF
path "kv/*" {
    capabilities = ["read", "list"]
}
EOF
```

配置带有组声明的 OIDC Role 以进行访问控制：

```bash
vault write auth/oidc/role/admin \
    bound_audiences="<idp_client_id>" \
    allowed_redirect_uris="https://vault.company.com/ui/vault/auth/oidc/oidc/callback" \
    allowed_redirect_uris="https://vault.company.com/oidc/callback" \
    allowed_redirect_uris="http://localhost:8250/oidc/callback" \
    user_claim="sub" \
    policies="vault-admin" \
    groups_claim="groups" \
    oidc_scopes="openid,profile,email"

vault write auth/oidc/role/reader \
    bound_audiences="<idp_client_id>" \
    allowed_redirect_uris="https://vault.company.com/ui/vault/auth/oidc/oidc/callback" \
    allowed_redirect_uris="https://vault.company.com/oidc/callback" \
    allowed_redirect_uris="http://localhost:8250/oidc/callback" \
    user_claim="sub" \
    policies="vault-kv-reader" \
    groups_claim="groups" \
    oidc_scopes="openid,profile,email"
```

创建外部 group

```bash
vault write identity/group \
    name="vault-admin" \
    policies="vault-admin" \
    type="external"

vault write identity/group \
    name="vault-kv-reader" \
    policies="vault-kv-reader" \
    type="external"
```

查看 OIDC accessor

```bash
vault auth list | grep auth_oidc_

vault auth list | grep auth_oidc_ | tr -s ' ' | cut -d ' ' -f3
```

查看  Group ID

```bash
vault list identity/group/id
```

创建别名，将 Authentik 组映射到 Vault 组

```bash
vault write identity/group-alias \
    mount_accessor="auth_oidc_d2997c34" \
    canonical_id="9fbb3c2e-da23-627e-fcb5-0393b880e358" \
    name="Admins"

vault write identity/group-alias \
    mount_accessor="auth_oidc_d2997c34" \
    canonical_id="f6074871-d4f5-79bc-b18f-45ad555ccb66" \
    name="Staff"
```

验证 Reader 权限

```bash
# Login as vault-kv-reader
vault login -method=oidc role="vault-kv-reader"

# Should work for reader role
vault kv list kv/

# Should fail for reader role
vault kv put kv/test-secret key=value
```

验证 Admin 权限

```bash
# Login as vault-admin
vault login -method=oidc role="vault-admin"

# Should work for admin role
vault kv put kv/test-secret key=value
vault kv get kv/test-secret
```

从安全出发的最佳设计原则：

