## 内置策略

```bash
vault read sys/policy/default
```

## 策略编写

### Capabilites

常用的 Capabilites：

1. create (POST/PUT) 允许在指定路径创建数据。只有很少的 Vault 部件会区分 create 和 update，所以大多数操作同时需要 create 以及 update 能力。需要区分二者的部分会在相关文档中说明。
2. read (GET) 允许读取指定路径的数据
3. update (POST/PUT) 允许修改指定路径的数据。对多数 Vault 部件来说，这隐含了在指定位置创建初始值的能力
4. delete (DELETE) 允许删除指定路径的数据
5. list (LIST) 允许罗列指定路径的所有值。要注意的是，经由 list 操作返回的键是未经策略过滤的。请勿在键名中编码敏感信息。不是所有后端都支持 list 操作

以下是更复杂的策略

```
# This section grants all access on "secret/*". Further restrictions can be
# applied to this broad policy, as shown below.
path "secret/*" {
    capabilities = ["create", "read", "update", "delete", "list"]
}

# Even though we allowed secret/*, this line explicitly denies
# secret/super-secret. This takes precedence.
path "secret/super-secret" {
    capabilities = ["deny"]
}

# Policies can also specify allowed, disallowed, and required parameters. Here
# the key "secret/restricted" can only contain "foo" (any value) and "bar" (one
# of "zip" or "zap").
path "secret/restricted" {
    capabilities = ["create"]
    allowed_parameters = {
        "foo" = []
        "bar" = ["zip", "zap"]
    }
}
```

### 路径匹配

策略基于路径匹配来验证一个请求所需要的能力

策略路径可以精准匹配确切的路径，或者可以使用 `*` 模式指定前缀匹配

>v1 和 v2 版本的 kv secret 引擎区别：v2 的路径里面需要加 `/data/` ，v1 则不需要

```
# Permit reading only "secret/foo". An attached token cannot read "secret/food"
# or "secret/foo/bar".
path "secret/foo" {
    capabilities = ["read"]
}

# Permit reading everything under "secret/bar". An attached token could read
# "secret/bar/zip", "secret/bar/zip/zap", but not "secret/bars/zip".
path "secret/bar/*" {
    capabilities = ["read"]
}

# Permit reading everything prefixed with "zip-". An attached token could read
# "secret/zip-zap" or "secret/zip-zap/zong", but not "secret/zip/zap
path "secret/zip-*" {
    capabilities = ["read"]
}

# Permit reading the "teamb" path under any top-level path under secret/
path "secret/+/teamb" {
    capabilities = ["read"]
}

# Permit reading secret/foo/bar/teamb, secret/bar/foo/teamb, etc.
path "secret/+/+/teamb" {
    capabilities = ["read"]
}
```

需要注意的是，`*` 与正则表达式中的同符号并不同义，Vault 仅允许 `*` 出现在模式的末尾。如果赋予了 list 能力，需要注意的是因为 list 操作总是作用于一个路径前缀上，所以策略定义的路径匹配模式必须使用前缀匹配（即以 `*` 结尾）。

### 路径匹配优先级

Vault 采用一组具有优先级的判定规则来决定最为具体的路径匹配

- 如果一个匹配模式被多个策略使用并能匹配上给定路径，Vault 会取其能力的并集
- 如果一个路径能被多个策略定义的不同的匹配模式所匹配，那么只有最高优先级的匹配会被采用

假设对给定路径 P，存在两条策略都能够匹配，它们的路径匹配模式分别是 P1 和 P2，Vault 采用如下优先级规则：

- 如果 P1 中第一个 `+` 或是 `*` 出现的位置早于 P2，那么采用 P2

- 如果 P1 以 `*` 结尾，而 P2 不是，那么采用 P2

- 如果 P1 包含更多的 + 段，那么采用 P2

- 如果 P1 更短，那么采用 P2

- 如果 P1 得到的字典序更小，那么采用 P2

举个例子，给定两个路径：`secret/*` 和 `secret/+/+/foo/*`，由于第一个通配符的位置相同（都在 `secret`/ 之后），并且都以 `*` 结尾，而后者拥有更多的通配符段（多了两个 `+/` 段），所以结果是使用 `secret/*` 路径模式的策略

## 密码策略

- <https://developer.hashicorp.com/vault/api-docs/system/policies-password>
- <https://developer.hashicorp.com/vault/docs/concepts/password-policies>

### 自定义密码策略

此策略将从字符集 abcde01234 生成密码。但是，密码必须至少包含 1 个来自 abcde 的字符和至少 1 个来自 01234  的字符。如果规则之间的字符集重叠，则会对字符集进行重复数据删除，以防止出现对重叠集的偏差。例如：如果有两个字符集规则：abcde 和  cdefg，则字符集 abcdefg 将用于生成候选密码，但每个 abcde 和 cdefg 中至少有一个字符仍必须出现在密码中。

```bash
vault write sys/policies/password/my-password-policy policy=-<< EOF
length = 20

rule "charset" {
    charset = "abcde"
    min-chars = 1
}

rule "charset" {
    charset = "01234"
    min-chars = 1
}
EOF
```

读取策略

```bash
vault read sys/policies/password/my-password-policy
```

删除策略

```bash
vault delete sys/policies/password/my-password-policy
```

### 默认的密码策略

Vault 附带默认密码策略，该策略适用于 Vault 生成的任何密码，无需明确的策略分配。默认策略要求密码包括：

```bash
20 characters total
1 uppercase character
1 lowercase character
1 number
1 special character
```

即：

```
length = 20
rule "charset" {
    charset = "abcdefghijklmnopqrstuvwxyz"
    min-chars = 1
}
rule "charset" {
    charset = "ABCDEFGHIJKLMNOPQRSTUVWXYZ"
    min-chars = 1
}
rule "charset" {
    charset = "0123456789"
    min-chars = 1
}
rule "charset" {
    charset = "-"
    min-chars = 1
}
```

