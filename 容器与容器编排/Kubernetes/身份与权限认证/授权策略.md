## 授权策略

Kubernetes 支持多种授权模块，如 ABAC 模式、RBAC 模式和 Webhook 模式，当管理员创建集群时，他们配置了应该在 API 服务器中使用的授权模块。
　　　　
如果配置了多个授权模块，Kubernetes 将检查每个模块，如果有任何模块授权请求，则可以继续请求，如果所有模块拒绝请求，则拒绝请求（HTTP 状态代码 403）。

### 请求属性

Request Attributes

| 属性                                    | 含义                             |
|-------------------------------------------|--------------------------------------|
| user                                      | 身份验证期间提供的用户字符串         |
| group                                     | 经过身份验证的用户所属的组名列表     |
| extra                                     | 由身份验证层提供的任意字符串密钥到字符串值的映射 |
| API                                       | 指示请求是否针对 API 资源            |
| Request path                              | 其他非资源终结点（如 `/api` 或 `/healthz`）的路径 |
| API request verb                          | API 动词 get、list、create、update、patch watch、proxy、redirect、delete 和 deletecollection 用于资源请求 |
| HTTP request web                          | HTTP 动词 get、post、put 和 delete 用于非资源请求 |
| Resource                                  | 正在访问的资源的 ID 或名称（仅限资源请求）- 对于使用 get、update、patch 和 delete 谓词的资源请求，必须提供资源名称 |
| Subresource                               | 正在访问的子资源（仅用于资源请求）   |
| Namespace                                 | 正在访问的对象的命名空间（仅适用于命名空间资源请求） |
| API group                                 | 正在访问的 API 组（仅用于资源请求）。空字符串指定核心API组 |

### 授权模块

Authorization Modules

- Node

专用的授权插件，根据 Pod 对象调度的结果为 Node 进行授权。

- ABAC (Attribute-based access control):

基于属性的访问控制（ABAC）定义了一种访问控制模式，通过使用将属性组合在一起的策略，将访问权限授予用户。这些策略可以使用任何类型的属性（用户属性、资源属性、对象、环境属性等）。

- RBAC (Role-based access control):

基于角色的访问控制（RBAC）是一种基于企业中各个用户的角色来管理对计算机或网络资源的访问的方法。在这种情况下，访问是单个用户执行特定任务（如查看、创建或修改文件）的能力。

使用 "rbac.authorization.k8s.io" API 驱动授权策略，并支持动态配置。

- Webhook

WebHook 其实就是一个 HTTP 回调：在发生某些事情时发生的 HTTP POST；通过 HTTP POST 的简单事件通知。实现 WebHooks 的 web 应用程序将在发生某些事情时向 URL 发送消息。

### 授权模式

查看当前的配置

```bash
grep authorization-mode /etc/kubernetes/manifests/kube-apiserver.yaml
```

默认的值为

```bash
- --authorization-mode=Node,RBAC
```

### 检查 API 访问权限

kubectl 提供 `auth can-i` 子命令，用于快速查询 API 授权层。该命令使用 SelfSubjectAccessReview API 来确定当前用户是否可以执行给定的操作，并且无论使用何种授权模式都可以工作。

```bash
kubectl auth can-i list pods
```

## RBAC 授权模块

### HTTP 方法与 API Endpoint Verb

HTTP 方法和 kubectl 命令的对应动作 (verb) 关系

| HTTP 方法 | Verb                                                         |
|-------------------------------------------|--------------------------------------|
| POST      | create                                                       |
| GET,HEAD  | get(for individual resources),list(for collections)          |
| PUT       | update                                                       |
| PATCH     | patch                                                        |
| DELETE    | delete(for individual resources),deletecollection(for collections) |

### Role 和 ClusterRole

在 RBAC API 中，角色包含表示一组权限的规则。权限纯粹是附加的（没有 “拒绝” 规则）。

- 用 Role 在命名空间中定义

角色只能用于授予对单个命名空间中资源的访问权限。

- 可以用 Cluster Role 在集群范围内定义。

ClusterRole 可用于授予与角色相同的权限，但由于它们是群集范围的，因此也可用于授予对以下对象的访问权限：群集范围的资源（如节点）；non-resource endpoints (like "`/healthz`")；所有命名空间中的命名空间资源（如 pods）（例如，运行 kubectl get pods 所需的所有命名空间）

### 内置的集群角色

kubernetes 内置了四个角色 <https://kubernetes.io/docs/reference/access-authn-authz/rbac/#user-facing-roles>

- cluster-admin:默认绑定 `system:master` group。
- admin: 未绑定 (None)
- edit: 未绑定 (None)
- view: 未绑定 (None)