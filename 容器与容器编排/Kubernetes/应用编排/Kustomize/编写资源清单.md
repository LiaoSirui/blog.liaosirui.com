## 组合和继承资源

构造资源集合并将其放到同一个文件或目录中管理。 Kustomize 提供基于不同配置文件来合并资源并向其应用一些补丁或者其他定制的能力

组合资源：

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - deployment.yaml
  - service.yaml
```

通常用如下的目录结构：

```bash
my-app/
├── base/              # 基础配置（所有环境共用）
│   ├── deployment.yaml
│   ├── service.yaml
│   └── kustomization.yaml # 声明基础资源
└── overlays/          # 环境补丁（每个环境单独一个目录）
    ├── dev/           # 测试环境
    │   ├── kustomization.yaml    # 声明要打哪些补丁
    │   └── patch-deployment.yaml # 测试环境的补丁（比如副本数1）
    └── prod/          # 生产环境
        ├── kustomization.yaml
        └── patch-deployment.yaml # 生产环境的补丁（比如副本数3）
```

Kustomize 中有 基准(bases) 和 覆盖(overlays) 的概念区分。 这里可以理解为目录级别 yaml 资源文件的继承。基准 为父类目录，覆盖 为子类重写目录

- 基准 是包含 kustomization.yaml 文件的一个目录，其中包含一组资源及其相关的定制

- 覆盖 也是一个目录，其中包含将其他 kustomization 目录当做 bases 来引用的 kustomization.yaml 文件。

在 prod 中可以继承 base

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../base
```

## Kustomize 转换器

### 添加标签和注解

为所有资源添加标签和/或注释。如果资源上已经存在标签或注释键，则值将被覆盖

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# 设置标签
commonLabels:
  someName: someValue
  managed-by: gitops

# 设置注释
commonAnnotations:
  version: "v1.2.3"

```

### 设置命名空间

通过确保所有资源位于正确的命名空间并遵循通用的命名约定和大小写，可以强制项目资源的一致性

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# 设置命名空间
namespace: staging

# 设置名称后缀以附加到名称
nameSuffix: -staging

```

### 自定义镜像

执行命令

```bash
cd k8s/overlays/prod
TAG_VERSION=3.4.5
ustomize edit set image foo/bar=harbor/foo/bar:$TAG_VERSION
```

对应 YAML 修改

```yaml
images:
  - name: foo/bar
    newName: harbor/foo/bar
    newTag: 3.4.5
```

## Kustomize 生成器

`Kustomize` 提供 `secretGenerator` 和 `configMapGenerator` ，可以基于文件或字面值来生成 `Secret 和 ConfigMap`

### configMapGenerator

configMaps 也可以直接从字面量创建：

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# 使用字面量
configMapGenerator:
  - name: my-server-env-vars
    literals:
      - SPRING_PROFILES_ACTIVE=production
      - LOG_LEVEL=INFO

```

可以生成

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: my-server-env-vars-gkmm8tkdd7
data:
  SPRING_PROFILES_ACTIVE: production
  LOG_LEVEL: INFO
```

注意上面生成的 ConfigMap 对象名称是 `my-server-env-vars-gkmm8tkdd7` 而不是 `my-server-env-vars`，这是正常的，如果 ConfigMap 内容发生变化，就可以触发 Deployment 的滚动更新

关闭后缀

```yaml
configMapGenerator:
  - name: my-server-env-vars
    literals:
      - SPRING_PROFILES_ACTIVE=production
      - LOG_LEVEL=INFO
		options:
      disableNameSuffixHash: true
# 也可以使用全局的 generatorOptions
```

可以使用`.env` 或`.properties` 文件创建 configMap：

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# 使用 .properties 文件
configMapGenerator:
  - name: my-application-properties
    files:
      - application.properties

# 使用 .env 文件
configMapGenerator:
  - name: mysql-options
    envs:
      - mysql.env

```

例如文件

```bash
> cat application.properties

# 最大鉴权码发送次数
sendSMS.maxAuthSendNumber=3
# 最大鉴权次数
sendSMS.maxAuthNumber=3
# 鉴权码过期时间(毫秒)
sendSMS.validationCodeExpirationTime=300000
# 鉴权码长度
sendSMS.VerificationCodeLength=4

> cat mysql.env

userName=root
host=127.0.0.1
```

分别会生成

```yaml
---
apiVersion: v1
data:
  application.properties: |
    # 最大鉴权码发送次数
    sendSMS.maxAuthSendNumber=3
    # 最大鉴权次数
    sendSMS.maxAuthNumber=3
    # 鉴权码过期时间(毫秒)
    sendSMS.validationCodeExpirationTime=300000
    # 鉴权码长度
    sendSMS.VerificationCodeLength=4
kind: ConfigMap
metadata:
  name: my-application-properties-4b89cmtdm5

---
apiVersion: v1
data:
  host: 127.0.0.1
  userName: root
kind: ConfigMap
metadata:
  name: mysql-env-7tm6425f4d
```

## secretGenerator

执行命令

```bash
cd k8s/overlays/prod
kustomize edit add secret demo-app-secret --from-literal=db-password=12345
```

对应 YAML

```yaml
secretGenerator:
  - literals:
      - db-password=12345
    name: demo-app-secret
    type: Opaque
```

不同类型 secret 生成的示例

```yaml
secretGenerator:

  - name: env_file_secret
    envs:
      - env.txt
    type: Opaque

  - name: test-tls
    files:
      - secret/tls.crt
      - secret/tls.key
    type: "kubernetes.io/tls"

```

### generatorOptions

`generatorOptions` 可以在每个生成器内的资源级别设置。这将创建标签和注释，以添加到所有 Kustomize 生成的资源

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

generatorOptions:
  # 添加到所有生成资源的标签
  labels:
    kustomize.generated.resources: somevalue
  # 添加到所有生成资源的注释
  annotations:
    kustomize.generated.resources: somevalue
  # 关闭后缀添加
  disableNameSuffixHash: true
```

## 补丁 Patch

### patches

`patches` 属性中可以直接指定一个 yaml 文件，也可以直接在该属性这里修改资源，补丁可以包括容器镜像、端口、环境变量等

例如

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

patches:
  - path: custom-env.yaml
```

Patch 的内容，`custom-env.yaml` 包含的环境变量如下所示： 

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: demo-app
spec:
  template:
    spec:
      containers:
        - name: app
          env:
            - name: CUSTOM_ENV_VARIABLE
              value: Value defined by Kustomize
```

上述可以让 Kustomize 找到需要修改的正确容器

除此之外，策略合并补丁还可以指定 target

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

patches:
  # 策略合并补丁
  - path: deployment-patch.yaml
    target:
      group: apps
      version: v1
      kind: Deployment
      name: my-app

```

也支持 JSON 补丁

```yaml
piVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

patches:
  # JSON 补丁
  - target:
      group: apps
      version: v1
      kind: Deployment
      name: my-app
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 5
      - op: add
        path: /metadata/annotations/app-version
        value: "v2.0"

```

### 其他

还可以使用 `patchStrategicMerge` 或`patchJson6902`（Deprecated）
