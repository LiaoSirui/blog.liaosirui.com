## 节点可分配资源

![节点容量](./.assets/资源预留/node-capacity.svg)

Kubernetes 节点上的 'Allocatable' 被定义为 Pod 可用计算资源量。 调度器不会超额申请 'Allocatable'。 目前支持 'CPU'、'memory' 和 'ephemeral-storage' 这几个参数。

- Kubelet Node Allocatable 用来为 Kube 组件和 System 进程预留资源，从而保证当节点出现满负荷时也能保证 Kube 和 System 进程有足够的资源。
- 目前支持 cpu, memory, `ephemeral-storage` 三种资源预留。
- Node Capacity 是节点的所有硬件资源，`kube-reserved` 是给 kube 组件预留的资源，`system-reserved` 是给系统进程预留的资源，`eviction-threshold` 是 kubelet 驱逐的阈值设定，allocatable 才是真正调度器调度 Pod 时的参考值（保证节点上所有 Pods 的 request 资源不超过 Allocatable）。

节点可分配资源的计算方式为：

```bash
Node Allocatable Resource = Node Capacity - Kube-reserved - system-reserved - eviction-threshold
```

### Kube 预留值

- KubeletConfiguration 设置：`kubeReserved: {}`。 示例值 `{cpu: 100m, memory: 100Mi, ephemeral-storage: 1Gi, pid=1000}`
- KubeletConfiguration 设置：`kubeReservedCgroup: ""`

`kubeReserved` 用来给诸如 `kubelet`、容器运行时等 Kubernetes 系统守护进程记述其资源预留值。 该配置并非用来给以 Pod 形式运行的系统守护进程预留资源

要选择性地对 Kubernetes 系统守护进程上执行 `kubeReserved` 保护，需要把 kubelet 的 `kubeReservedCgroup` 设置的值设为 kube 守护进程的父控制组， 并将 `kube-reserved` 添加到 `enforceNodeAllocatable`。

### 系统预留值

- KubeletConfiguration 设置：`systemReserved: {}`。 示例值 `{cpu: 100m, memory: 100Mi, ephemeral-storage: 1Gi, pid=1000}`
- KubeletConfiguration 设置：`systemReservedCgroup: ""`

`systemReserved` 用于为诸如 `sshd`、`udev` 等系统守护进程记述其资源预留值。 `systemReserved` 也应该为 `kernel` 预留 `内存`，因为目前 `kernel` 使用的内存并不记在 Kubernetes 的 Pod 上。 同时还推荐为用户登录会话预留资源（systemd 体系中的 `user.slice`）。

实施 `systemReserved` 约束，需指定 kubelet 的 `systemReservedCgroup` 设置值为 OS 系统守护进程的父级控制组， 并将 `system-reserved` 添加到 `enforceNodeAllocatable`

### 显式预留的 CPU 列表

- KubeletConfiguration 设置：`reservedSystemCPUs:`。示例值 `0-3`

旨在为操作系统守护程序和 Kubernetes 系统守护程序预留一组明确指定编号的 CPU。 `reservedSystemCPUs` 适用于不打算针对 cpuset 资源为操作系统守护程序和 Kubernetes 系统守护程序定义独立的顶级 cgroups 的系统。 如果 Kubelet 没有指定参数 `kubeReservedCgroup` 和 `systemReservedCgroup`， 则 `reservedSystemCPUs` 的设置将优先于 `kubeReservedCgroup` 和 `systemReservedCgroup` 选项。

### 驱逐阈值

- KubeletConfiguration 设置： `evictionHard: {memory.available: "100Mi", nodefs.available: "10%", nodefs.inodesFree: "5%", imagefs.available: "15%"}`

节点级别的内存压力将导致系统内存不足，这将影响到整个节点及其上运行的所有 Pod。 节点可以暂时离线直到内存已经回收为止。

驱逐操作只支持 `memory` 和 `ephemeral-storage`。 通过 `evictionHard` 设置预留一些内存后，当节点上的可用内存降至预留值以下时， `kubelet` 将尝试驱逐 Pod。 如果节点上不存在系统守护进程，Pod 将不能使用超过 `capacity-eviction-hard` 所指定的资源量。 因此，为驱逐而预留的资源对 Pod 是不可用的。

### 配置带 cgroup 的资源预留

- KubeletConfiguration 设置：`enforceNodeAllocatable: [pods]`。 示例值：`[pods,system-reserved,kube-reserved]`

kubelet 默认对 Pod 执行 Allocatable 可分配约束，如果所有 Pod 的总用量超过了 Allocatable，那么驱逐 Pod 的措施将被执行，可以通过设置 `kubelet --enforce-node-allocatable` 标志值为 pods 控制这个措施。

此外还可以通过该标志来同时指定 `kube-reserved` 和 `system-reserved` 值，可以让 kubelet 强制实施 `kube-reserved` 和 `system-reserved` 约束，不过需要注意，如果配置了 `kube-reserved` 或者 `system-reserved` 约束，那么需要对应设置 `--kube-reserved-cgroup` 或者 `--system-reserved-cgroup` 参数。

如果设置了对应的 `--system-reserved-cgroup` 和 `--kube-reserved-cgroup` 参数，Pod 能实际使用的资源上限是不会改变，但系统进程与 kube 进程也会受到资源上限的限制，如果系统进程超过了预留资源，那么系统进程会被 cgroup 杀掉。但是如果不设这两个参数，那么系统进程就可以使用超过预留的资源上限。

所以如果要为系统预留和 kube 预留配置 cgroup，则需要非常小心，如果执行了 `kube-reserved` 约束，那么 kubelet 就不能出现突发负载用光所有可用资源，不然就会被杀掉。`system-reserved` 可以用于为诸如 sshd、udev 等系统守护进程争取资源预留，但是如果执行 `system-reserved` 约束，那么可能因为某些原因导致节点上的关键系统服务 CPU 资源短缺或因为内存不足而被终止。

因此，使用 `enforce-node-allocatable` 默认配置的 pods 即可，并为系统和 kube 进程预留出适当的资源，以保持整体节点的可靠性，不需要进行 cgroup 约束。

如果需要进行：

```bash
mkdir -p /sys/fs/cgroup/cpu,cpuacct/kubelet.slice
mkdir -p /sys/fs/cgroup/memory/kubelet.slice
mkdir -p /sys/fs/cgroup/systemd/kubelet.slice
mkdir -p /sys/fs/cgroup/pids/kubelet.slice
mkdir -p /sys/fs/cgroup/cpu,cpuacct/kubelet.slice
mkdir -p /sys/fs/cgroup/cpuset/kubelet.slice
mkdir -p /sys/fs/cgroup/hugetlb/kubelet.slice
```

此后指定：

```yaml
kubeReservedCgroup: /kubelet.slice
```

## Kubelet 参数配置

### Eviction

生产环境如果集群管理员对集群缺乏足够的把控力，建议关闭驱逐，显示设置 `--eviction-hard=` 即可关闭，关闭之后驱逐相关的其他参数就不需要关注

```bash
--eviction-hard
# default imagefs.available<15%,memory.available<100Mi,nodefs.available<10%
```

触发 Pod 驱逐操作的一组硬性门限（例如：`memory.available<1Gi` （内存可用值小于 1G）设置。在 Linux 节点上，默认值还包括 `nodefs.inodesFree<5%`

```bash
--eviction-minimum-reclaim
```

当某资源压力过大时，kubelet 将执行 Pod 驱逐操作。此参数设置软性驱逐操作需要回收的资源的最小数量（例如：`imagefs.available=2Gi`）

```bash
--eviction-pressure-transition-period
# default 5m
```

kubelet 在驱逐压力状况解除之前的最长等待时间

```bash
--eviction-max-pod-grace-period
```

响应满足软性驱逐阈值（Soft Eviction Threshold）而终止 Pod 时使用的最长宽限期（以秒为单位）。如果设置为负数，则遵循 Pod 的指定值

```bash
--eviction-soft
```

设置一组驱逐阈值（例如：`memory.available<1.5Gi`）。如果在相应的宽限期内达到该阈值，则会触发 Pod 驱逐操作

```bash
--eviction-soft-grace-period
```

设置一组驱逐宽限期（例如，`memory.available=1m30s`），对应于触发软性 Pod 驱逐操作之前软性驱逐阈值所需持续的时间长短

### Reserve

```bash
--kube-reserved
```

kubernetes 系统预留的资源配置，以一组 `<资源名称>=<资源数量>` 格式表示。（例如：`cpu=200m,memory=500Mi,ephemeral-storage=1Gi,pid='100'`）。当前支持 `cpu`、`memory` 和用于根文件系统的 `ephemeral-storage`

```bash
--qos-reserved
```

设置在指定的 QoS 级别预留的 Pod 资源请求，以一组 `"资源名称=百分比"` 的形式进行设置，例如 `memory=50%`。当前仅支持内存（memory）。要求启用 `QOSReserved` 特性门控

```bash
--reserved-cpus
```

用逗号分隔的一组 CPU 或 CPU 范围列表，给出为系统和 Kubernetes 保留使用的 CPU。此列表所给出的设置优先于通过 `--system-reserved` 和 `--kube-reskube-reserved` 所保留的 CPU 个数配置

```bash
--reserved-memory
```

以逗号分隔的 NUMA 节点内存预留列表。（例如 `--reserved-memory 0:memory=1Gi,hugepages-1M=2Gi --reserved-memory 1:memory=2Gi`）。每种内存类型的总和应该等于`--kube-reserved`、`--system-reserved`和`--eviction-threshold`

```bash
--system-reserved
```

系统预留的资源配置，以一组 `资源名称=资源数量` 的格式表示， （例如：`cpu=200m,memory=500Mi,ephemeral-storage=1Gi,pid='100'`）。目前仅支持 `cpu` 和 `memory` 的设置

## 示例

这是一个用于说明节点可分配（Node Allocatable）计算方式的示例：

- 节点拥有 `32Gi` `memory`、`16 CPU` 和 `100Gi` `Storage` 资源
- `kubeReserved` 被设置为 `{cpu: 1000m, memory: 2Gi, ephemeral-storage: 1Gi}`
- `systemReserved` 被设置为 `{cpu: 500m, memory: 1Gi, ephemeral-storage: 1Gi}`
- `evictionHard` 被设置为 `{memory.available: "<500Mi", nodefs.available: "<10%"}`

在这个场景下，'Allocatable' 将会是 14.5 CPUs、28.5Gi 内存以及 `88Gi` 本地存储。 调度器保证这个节点上的所有 Pod 的内存 `requests` 总量不超过 28.5Gi，存储不超过 '88Gi'。 当 Pod 的内存使用总量超过 28.5Gi 或者磁盘使用总量超过 88Gi 时，kubelet 将会驱逐它们。 如果节点上的所有进程都尽可能多地使用 CPU，则 Pod 加起来不能使用超过 14.5 CPUs 的资源。

当没有执行 `kubeReserved` 和/或 `systemReserved` 策略且系统守护进程使用量超过其预留时， 如果节点内存用量高于 31.5Gi 或 `storage` 大于 90Gi，kubelet 将会驱逐 Pod