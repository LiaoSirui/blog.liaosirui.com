## 先决条件

### k8s

IPv4/IPv6 双协议栈网络能够将 IPv4 和 IPv6 地址分配给 Pod 和 Service。

从 1.21 版本开始，Kubernetes 集群默认启用 IPv4/IPv6 双协议栈网络， 以支持同时分配 IPv4 和 IPv6 地址。

如果配置 IPv4/IPv6 双栈，请分配双栈集群网络：

- kube-apiserver：
  - `--service-cluster-ip-range=<IPv4 CIDR>,<IPv6 CIDR>`
- kube-controller-manager：
  - `--cluster-cidr=<IPv4 CIDR>,<IPv6 CIDR>`
  - `--service-cluster-ip-range=<IPv4 CIDR>,<IPv6 CIDR>`
  - `--node-cidr-mask-size-ipv4|--node-cidr-mask-size-ipv6` 对于 IPv4 默认为 /24， 对于 IPv6 默认为 /64
- kube-proxy：
  - `--cluster-cidr=<IPv4 CIDR>,<IPv6 CIDR>`
- kubelet：
  - `--node-ip=<IPv4 IP>,<IPv6 IP>`
    - 裸机双栈节点（未使用 `--cloud-provider` 标志定义云平台的节点）需要此选项。 如果使用了某个云平台并选择覆盖云平台所选择的节点 IP，请设置 `--node-ip` 选项。
    - （传统的内置云平台实现不支持双栈 `--node-ip`。）

Service 的地址族默认为第一个服务集群 IP 范围的地址族（通过 kube-apiserver 的 `--service-cluster-ip-range` 参数配置）。

当定义 Service 时，可以选择将其配置为双栈。若要指定所需的行为，可以设置 `.spec.ipFamilyPolicy` 字段为以下值之一：

- `SingleStack`：单栈 Service。控制面使用第一个配置的服务集群 IP 范围为 Service 分配集群 IP。
- `PreferDualStack`：启用双栈时，为 Service 同时分配 IPv4 和 IPv6 集群 IP 地址。 如果双栈未被启用或不被支持，则会返回到单栈行为。
- `RequireDualStack`：启用双栈时，同时从 IPv4 和 IPv6 的地址范围中分配 Service 的 `.spec.clusterIPs`。 如果双栈未被启用或不被支持，则 Service API 对象创建失败。

对于不带选择算符的无头服务，若没有显式设置 `.spec.ipFamilyPolicy`，则 `.spec.ipFamilyPolicy` 字段默认设置为 `RequireDualStack`