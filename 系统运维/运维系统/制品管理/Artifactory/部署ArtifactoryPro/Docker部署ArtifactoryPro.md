
## 准备镜像

拉取官方镜像：

```bash
docker pull releases-docker.jfrog.io/jfrog/artifactory-pro:7.55.6
# docker pull docker.bintray.io/jfrog/artifactory⁠-⁠pro:7.55.6
# 也可以选择 latest 标签
```

## 安装

### 启动原版容器

准备一个持久化路径

```bash
export JFROG_HOME=/data/sdb
```

创建配置文件目录

```bash
mkdir -p $JFROG_HOME/artifactory/var/etc/
```

创建一个配置文件

```bash
cd $JFROG_HOME/artifactory/var/etc/

touch ./system.yaml
```

更改权限

```bash
chown -R 1030:1030 $JFROG_HOME/artifactory/var
```

运行容器

```bash
# for debug
docker run \
 --name artifactory \
 -v $JFROG_HOME/artifactory/var/:/var/opt/jfrog/artifactory \
 -it \
 --rm \
 -p 18081:8081 \
 -p 18082:8082 \
 harbor.local.liaosirui.com:5000/3rdparty/releases-docker.jfrog.io/jfrog/artifactory-pro:7.55.6
```

等待启动完成

#### hack

下载一个 injector

<https://gitee.com/chenjim/chenjimblog/tree/master/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E5%85%B7/data/artifactory>

新开一个终端

```bash
export JFROG_HOME=/data/sda/sda4

cd $JFROG_HOME/artifactory/var/etc/
```

放置下载的 injector 到此

```bash
cp /data/artifactory-injector-1.1.jar .
```

进入容器

```bash
docker exec -it artifactory /bin/bash
```

执行如下步骤

```bash
# cd /var/opt/jfrog/artifactory/etc
$ java -jar artifactory-injector-1.1.jar
What do you want to do?
1 - generate License String
2 - inject artifactory
exit - exit
2
where is artifactory home? ("back" for back)
/opt/jfrog/artifactory
artifactory detected. continue? (yes/no)
yes
putting another WEB-INF/lib/artifactory-addons-manager-6.6.0.jar
META-INF/
org/
org/jfrog/
...
What do you want to do?
1 - generate License String
2 - inject artifactory
exit - exit
exit
```

默认使用如下 key

```text
eyJhcnRpZmFjdG9yeSI6eyJpZCI6IiIsIm93bmVyIjoicjRwMyIsInZhbGlkRnJvbSI6MTYzNDEzODYwNDc5MSwiZXhwaXJlcyI6NDc4OTgxMjIwNDc2NiwidHlwZSI6IkVOVEVSUFJJU0VfUExVUyIsInRyaWFsIjpmYWxzZSwicHJvcGVydGllcyI6e319fQ==
```

重新生成一个容器

```bash
docker commit artifactory releases-docker.jfrog.io/jfrog/artifactory-pro:6.9.0-hack
```

使用新生成的容器运行

```bash
export JFROG_HOME=/data/sda/sda4

docker run \
 --name artifactory \
 -v $JFROG_HOME/artifactory/var/:/var/opt/jfrog/artifactory \
 -itd \
 --restart=always \
 -p 18081:8081 \
 -p 18082:8082 \
  releases-docker.jfrog.io/jfrog/artifactory-pro:6.9.0-hack
```

#### 配置反向代理

从 IP 地址访问 artifactory

<http://192.168.1.99:18081/artifactory/webapp/#/home>

默认登录用户名 admin / password

新建一个配置文件存放

```bash
export JFROG_HOME=/data/sda/sda4

mkdir -p $JFROG_HOME/nginx/cert

mkdir -p $JFROG_HOME/nginx/conf
```

生成一对自签证书

```bash
cd $JFROG_HOME/nginx/cert

openssl req -x509 -nodes -days 700 -newkey rsa:2048 -keyout artifactory-tls.key -out artifactory-ca.crt -subj "/CN=artifactory.local.liaosirui.com"

chmod 777 artifactory-*
```

在 Artifactory 生成配置文件

拷贝 nginx 配置文件

````nginx
###########################################################
## this configuration was generated by JFrog Artifactory ##
###########################################################

## add ssl entries when https has been set in config
ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
ssl_certificate      /cert/artifactory-ca.crt;
ssl_certificate_key  /cert/artifactory-tls.key;
ssl_session_cache shared:SSL:1m;
ssl_prefer_server_ciphers   on;
## server configuration
server {
    listen 9443 ssl;
    listen 9080 ;
    
    server_name artifactory.local.liaosirui.com;
    if ($http_x_forwarded_proto = '') {
        set $http_x_forwarded_proto  $scheme;
    }
    ## Application specific logs
    ## access_log /var/log/nginx/artifactory.local.liaosirui.com-access.log timing;
    ## error_log /var/log/nginx/artifactory.local.liaosirui.com-error.log;
    rewrite ^/$ /artifactory/webapp/ redirect;
    rewrite ^/artifactory/?(/webapp)?$ /artifactory/webapp/ redirect;
    rewrite ^/(v2)/(.*) /artifactory/$1/$2;
    chunked_transfer_encoding on;
    client_max_body_size 0;
    location /artifactory/ {
    proxy_read_timeout  2400s;
    proxy_pass_header   Server;
    proxy_cookie_path   ~*^/.* /;
    if ( $request_uri ~ ^/artifactory/(.*)$ ) {
        proxy_pass          http://artifactory:8081/artifactory/$1;
    }
    proxy_pass          http://artifactory:8081/artifactory/;
    proxy_set_header    X-Artifactory-Override-Base-Url $http_x_forwarded_proto://$host:$server_port/artifactory;
    proxy_set_header    X-Forwarded-Port  $server_port;
    proxy_set_header    X-Forwarded-Proto $http_x_forwarded_proto;
    proxy_set_header    Host              $http_host;
    proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
    }
}

````

创建配置文件

```bash
vim artifactory.conf
# 写入自动生成的配置文件
```

运行如下

```bash
docker run --name artifactory-pro-nginx \
    -p 9080:9080 \
    -p 9443:9443 \
    -itd \
    --restart=always \
    -e SKIP_AUTO_UPDATE_CONFIG=true \
    --link artifactory:artifactory \
    -v $JFROG_HOME/nginx/conf:/var/opt/jfrog/nginx/conf.d/  \
    -v $JFROG_HOME/nginx/cert:/cert  \
    --name artifactory-proxy \
    releases-docker.jfrog.io/jfrog/nginx-artifactory-pro:latest
```

